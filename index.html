<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>סטטיסטיקת ערך ויקיפדיה • ניתוח ותובנות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
<main class="max-w-6xl mx-auto p-4">
  <header class="mb-4">
    <h1 class="text-2xl font-bold">סטטיסטיקת ערך ויקיפדיה</h1>
    <p class="text-sm text-gray-600">חקירת צפיות ועריכות ‐ ערך יחיד או השוואה; עם החלקה, חריגות, טווח קודם וקורלציה.</p>
  </header>

  <!-- Controls -->
  <section class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
    <div class="flex flex-wrap gap-3 items-center">
      <input id="pageTitle1" type="text" autocomplete="off" placeholder="שם ערך ראשון"
             class="p-2 border border-gray-300 rounded w-full sm:w-auto flex-1 min-w-[160px]">
      <input id="pageTitle2" type="text" autocomplete="off" placeholder="שם ערך שני (לא חובה)"
             class="p-2 border border-gray-300 rounded w-full sm:w-auto flex-1 min-w-[160px]">
      <select id="granularitySelect" class="p-2 border border-gray-300 rounded">
        <option value="daily" selected>רמת פירוט יומית</option>
        <option value="monthly">רמת פירוט חודשית</option>
      </select>
      <select id="rangeSelect" class="p-2 border border-gray-300 rounded">
        <option value="7">7 ימים אחרונים</option>
        <option value="30" selected>30 ימים אחרונים</option>
        <option value="90">90 ימים אחרונים</option>
        <option value="180">180 ימים אחרונים</option>
        <option value="365">365 ימים אחרונים</option>
        <option value="all">מאז ומעולם</option>
      </select>

      <div class="flex items-center gap-4 ml-auto">
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleSmoothing" type="checkbox" class="accent-blue-600">
          החלק מגמה
        </label>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleComparePrev" type="checkbox" class="accent-blue-600">
          השווה לטווח קודם
        </label>
        <button id="loadDataButton" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">הצג נתונים</button>
        <button id="downloadCSVButton" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">הורד CSV</button>
      </div>
    </div>

    <div id="loadingIndicator" class="hidden flex items-center gap-2 mt-3" aria-live="polite">
      <div class="animate-spin rounded-full h-6 w-6 border-t-4 border-blue-600"></div>
      <span class="text-sm">טוען נתונים...</span>
    </div>
    <div id="errorMessage" class="mt-2 text-red-600 font-bold hidden" role="alert"></div>
  </section>

  <!-- KPI per article -->
  <section id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 hidden"></section>

  <div id="wikiLinks" class="mt-3 text-blue-700 font-bold"></div>

  <section id="pageInfo" class="mt-3 text-right text-base leading-7 bg-white p-4 rounded shadow-sm border border-gray-200 hidden">
    <span class="block font-bold text-lg mb-1">סטטיסטיקת ערכים</span>
    <div id="summaryContent"></div>
  </section>

  <section class="mt-4">
    <h2 id="viewsSummary" class="font-bold text-lg hidden">צפיות לאורך זמן</h2>
    <div class="w-full overflow-x-auto">
      <canvas id="viewsChart" class="!max-h-[42vh] w-full"></canvas>
    </div>
  </section>

  <section class="mt-8">
    <h2 id="editsSummary" class="font-bold text-lg hidden">עריכות לאורך זמן</h2>
    <div class="w-full overflow-x-auto">
      <canvas id="editsChart" class="!max-h-[42vh] w-full"></canvas>
    </div>
  </section>

  <!-- Insights sections -->
  <section id="insights" class="mt-6 space-y-4">
    <div id="anomaliesBox" class="hidden bg-white border border-amber-300 rounded p-4"></div>
    <div id="corrBox" class="hidden bg-white border border-gray-200 rounded p-4"></div>
  </section>
</main>

<div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded shadow z-50">הנתונים נטענו</div>

<script>
/* ====================== STATE ====================== */
let viewsChart, editsChart;
const state = {
  articles: [
    { title: '', dates: [], views: [], edits: [], createdDate: null },
    { title: '', dates: [], views: [], edits: [], createdDate: null }
  ],
  features: { smoothing: false, comparePrev: false }
};

/* ====================== UTILS ====================== */
function show(e){e.classList.remove('hidden')} function hide(e){e.classList.add('hidden')}
function toast(msg='הנתונים נטענו'){const t=document.getElementById('toast');t.textContent=msg;show(t);setTimeout(()=>hide(t),1800)}
function formatDisplay(d){try{const date=new Date(d);return date.toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'2-digit'}).replace(/(\d{2})\.(\d{2})\.(\d{2})/,'$1/$2/$3')}catch{return d}}
function parseDisplayDate(s,g='daily'){try{if(g==='monthly'){const[m,y]=s.split('/');return new Date(`20${y}-${m}-01`)}else{const[d,m,y]=s.split('/');return new Date(`20${y}-${m}-${d}`)}}catch{return new Date()}}
function generateMonthlyDates(startDate,endDate){const out=[];let c=new Date(startDate.getFullYear(),startDate.getMonth(),1);const end=new Date(endDate.getFullYear(),endDate.getMonth(),1);while(c<=end){const m=String(c.getMonth()+1).padStart(2,'0');const y=String(c.getFullYear()).slice(2);out.push(`${m}/${y}`);c.setMonth(c.getMonth()+1)}return out.sort((a,b)=>parseDisplayDate(a,'monthly')-parseDisplayDate(b,'monthly'))}

/* Smoothing (SMA/EMA) */
function sma(arr, k=7){
  const out = Array(arr.length).fill(null);
  let sum = 0, q = [];
  for (let i=0; i<arr.length; i++){
    const v = arr[i] ?? 0;
    q.push(v); sum += v;
    if (q.length > k) sum -= q.shift();
    if (q.length === k) out[i] = Math.round(sum / k);
  }
  return out;
}

/* Anomalies (Median / MAD) */
function median(arr){const a=arr.filter(v=>v!=null).slice().sort((x,y)=>x-y);if(!a.length)return 0;const m=Math.floor(a.length/2);return a.length%2?a[m]:Math.round((a[m-1]+a[m])/2)}
function mad(arr){const m=median(arr);const dev=arr.filter(v=>v!=null).map(v=>Math.abs(v-m));return median(dev)||1}
function findSpikes(dates, values, thresh=4){
  const m = median(values), M = mad(values);
  const res = [];
  for (let i=0;i<values.length;i++){
    const v = values[i]; if (v==null) continue;
    const score = Math.abs(v - m) / M;
    if (score >= thresh) res.push({ idx: i, date: dates[i], value: v, score: +score.toFixed(2) });
  }
  return res;
}

/* Prev period & misc */
function sumNonNull(arr){return arr.reduce((s,v)=>s+(v||0),0)}
function shiftSeries(values, shift){
  const out = Array(values.length).fill(null);
  for (let i=0;i<values.length;i++){const j=i-shift; out[i]=(j>=0)?values[j]:null;}
  return out;
}

/* Correlation (Pearson) */
function pearson(x, y){
  const xs=[], ys=[];
  for (let i=0;i<x.length;i++){const a=x[i], b=y[i]; if(a!=null && b!=null){xs.push(a); ys.push(b);}}
  if (xs.length < 3) return null;
  const n=xs.length, sum=a=>a.reduce((s,v)=>s+v,0);
  const sumx=sum(xs), sumy=sum(ys);
  const sumxx=sum(xs.map(v=>v*v)), sumyy=sum(ys.map(v=>v*v));
  const sumxy=sum(xs.map((v,i)=>v*ys[i]));
  const num = n*sumxy - sumx*sumy;
  const den = Math.sqrt((n*sumxx - sumx*sumx)*(n*sumyy - sumy*sumy));
  if (!den) return 0;
  return +(num/den).toFixed(2);
}

/* URL state with safe fallback */
function isSafeToReplaceState(){try{const p=location.protocol;const http=p==='http:'||p==='https:';const isTop=window.self===window.top;const notAbout=!location.href.startsWith('about:');return http&&isTop&&notAbout}catch{return false}}
function saveStateToURL(){
  try{
    const p=new URLSearchParams();
    p.set('p1',document.getElementById('pageTitle1').value.trim());
    p.set('p2',document.getElementById('pageTitle2').value.trim());
    p.set('g',document.getElementById('granularitySelect').value);
    p.set('r',document.getElementById('rangeSelect').value);
    p.set('sm', document.getElementById('toggleSmoothing').checked ? '1' : '0');
    p.set('cp', document.getElementById('toggleComparePrev').checked ? '1' : '0');
    const qs=p.toString();
    if(isSafeToReplaceState()) history.replaceState(null,'',`${location.pathname}?${qs}`);
    else location.hash=`state=${encodeURIComponent(qs)}`;
  }catch{}
}
function loadStateFromURL(){
  try{
    let search='';
    if(isSafeToReplaceState()) search=location.search;
    else if(location.hash.startsWith('#state=')) search='?'+decodeURIComponent(location.hash.slice('#state='.length));
    const params=new URLSearchParams(search);
    const get = k => params.get(k);
    if(get('p1')) document.getElementById('pageTitle1').value=get('p1');
    if(get('p2')) document.getElementById('pageTitle2').value=get('p2');
    if(get('g')) document.getElementById('granularitySelect').value=get('g');
    if(get('r')) document.getElementById('rangeSelect').value=get('r');
    if(get('sm')) document.getElementById('toggleSmoothing').checked = get('sm')==='1';
    if(get('cp')) document.getElementById('toggleComparePrev').checked = get('cp')==='1';
  }catch{}
}

/* Local storage for toggles */
function loadTogglesFromStorage(){
  try{
    const sm = localStorage.getItem('toggleSmoothing');
    const cp = localStorage.getItem('toggleComparePrev');
    if (sm !== null) document.getElementById('toggleSmoothing').checked = sm === '1';
    if (cp !== null) document.getElementById('toggleComparePrev').checked = cp === '1';
  } catch {}
}
function saveTogglesToStorage(){
  try{
    localStorage.setItem('toggleSmoothing', document.getElementById('toggleSmoothing').checked ? '1' : '0');
    localStorage.setItem('toggleComparePrev', document.getElementById('toggleComparePrev').checked ? '1' : '0');
  } catch {}
}

/* ====================== CACHE ====================== */
const CACHE_TTL_MS=10*60*1000;
function cacheGet(k){try{const raw=sessionStorage.getItem(k);if(!raw) return null;const {ts,data}=JSON.parse(raw);if(Date.now()-ts>CACHE_TTL_MS){sessionStorage.removeItem(k);return null}return data}catch{return null}}
function cacheSet(k,d){try{sessionStorage.setItem(k,JSON.stringify({ts:Date.now(),data:d}))}catch{}}

/* ====================== API ====================== */
async function fetchViewsData(title,startStr,endStr){
  const key=`views:${title}:${startStr}:${endStr}`;const c=cacheGet(key);if(c) return c;
  try{
    const t=encodeURIComponent(title);
    const url=`https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/he.wikipedia.org/all-access/user/${t}/daily/${startStr}/${endStr}`;
    const res=await fetch(url); if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json();
    const dates=(data.items||[]).map(i=>formatDisplay(`${i.timestamp.slice(0,4)}-${i.timestamp.slice(4,6)}-${i.timestamp.slice(6,8)}`));
    const views=(data.items||[]).map(i=>i.views||0);
    const out={dates,views}; cacheSet(key,out); return out;
  }catch(e){console.error('views',e);return {dates:[],views:[],error:`לא ניתן לטעון נתוני צפיות עבור "${title}"`}}
}
async function fetchEditsData(title,startDate,endDate,granularity,displayDates){
  const key=`edits:${title}:${startDate.toISOString().slice(0,10)}:${endDate.toISOString().slice(0,10)}:${granularity}`;
  const c=cacheGet(key); if(c) return c;
  try{
    const t=encodeURIComponent(title); const map={}; let cont=null,done=false;
    while(!done){
      let url=`https://he.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles=${t}&rvlimit=500&rvstart=${endDate.toISOString()}&rvend=${startDate.toISOString()}&rvprop=timestamp&origin=*`;
      if(cont) url+=`&rvcontinue=${cont}`;
      const res=await fetch(url); if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j=await res.json(); const page=Object.values(j.query.pages||{})[0]||{}; const revs=page.revisions||[];
      for(const r of revs){
        if(granularity==='monthly'){const d=new Date(r.timestamp);const key=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(2)}`;map[key]=(map[key]||0)+1;}
        else{const day=formatDisplay(r.timestamp);map[day]=(map[day]||0)+1;}
      }
      if(j.continue && j.continue.rvcontinue) cont=j.continue.rvcontinue; else done=true;
    }
    const arr=displayDates.map(d=>map[d]||0); cacheSet(key,arr); return arr;
  }catch(e){console.error('edits',e);const z=Array(displayDates.length).fill(0);cacheSet(key,z);return z}
}
async function fetchPageInfo(title){
  const key=`pageinfo:${title}`;const c=cacheGet(key);if(c) return c;
  try{
    const t=encodeURIComponent(title);
    const first=await fetch(`https://he.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles=${t}&rvlimit=1&rvdir=newer&rvprop=timestamp|user&origin=*`);
    if(!first.ok) throw new Error(`HTTP ${first.status}`); const f=await first.json();
    const pageA=Object.values(f.query.pages||{})[0]; if(!pageA||pageA.missing){const miss={missing:true};cacheSet(key,miss);return miss}
    const created=pageA.revisions?.[0];
    const last=await fetch(`https://he.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles=${t}&rvlimit=1&rvprop=timestamp|user&origin=*`);
    if(!last.ok) throw new Error(`HTTP ${last.status}`); const l=await last.json();
    const lastEdit=Object.values(l.query.pages||{})[0]?.revisions?.[0];
    const out={created,lastEdit,missing:false}; cacheSet(key,out); return out;
  }catch(e){console.error('pageinfo',e);return {missing:true,error:`לא ניתן לטעון מידע עבור "${title}"`}}
}
async function fetchRecentEdits(title){
  const key=`recent:${title}`;const c=cacheGet(key);if(c) return c;
  try{
    const t=encodeURIComponent(title);
    const res=await fetch(`https://he.wikipedia.org/w/api.php?action=query&format=json&prop=revisions&titles=${t}&rvlimit=4&rvprop=timestamp|user|comment|ids&rvdir=older&origin=*`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j=await res.json(); const revs=Object.values(j.query.pages||{})[0]?.revisions||[];
    cacheSet(key,revs); return revs;
  }catch(e){console.error('recent',e);return []}
}

/* ====================== RENDER ====================== */
function renderWikiLinks(articles){
  document.getElementById('wikiLinks').innerHTML = articles.map(a=>{
    const enc=encodeURIComponent(a.title);
    return `<a href="https://he.wikipedia.org/wiki/${enc}" target="_blank" class="mr-4 underline">לצפייה בערך "${a.title}" בוויקיפדיה »</a>`;
  }).join('');
}
function renderSummaries(articles,displayDates,infos){
  const box=document.getElementById('summaryContent'); let html='';
  for(let i=0;i<articles.length;i++){
    const idx=articles[i].index, info=infos[i], a=state.articles[idx];
    const last=info.lastEdit;
    let warn=''; if(last){const mins=Math.floor((Date.now()-new Date(last.timestamp))/60000);const h=Math.floor(mins/60),m=mins%60; if(h<5){warn=` <span class="text-red-600">(העריכה האחרונה הייתה לפני ${h>0?`${h} שעות ו-${m} דקות`:`${m} דקות`})</span>`}}
    const viewsAll=a.views.filter(v=>v!=null); const totalV=viewsAll.reduce((s,v)=>s+(v||0),0);
    const maxV=viewsAll.length?Math.max(...viewsAll):0;
    const maxVDate=viewsAll.length?(a.dates[a.views.map(v=>v??0).indexOf(maxV)]||'N/A'):'N/A';
    const maxE=a.edits.length?Math.max(...a.edits):0;
    const maxEDate=a.edits.length?displayDates[a.edits.indexOf(maxE)]:'N/A';
    html+=`
      <div class="mb-4">
        <b>ערך: ${a.title}</b><br>
        <b>טווח:</b> ${displayDates[displayDates.length-1]||'N/A'} - ${displayDates[0]||'N/A'}<br>
        <b>נוצר על ידי:</b> ${info.created?.user||'לא זמין'} בתאריך ${info.created?formatDisplay(info.created.timestamp):'N/A'}<br>
        <b>העריכה האחרונה:</b> ${last?.user||'לא זמין'} בתאריך ${last?formatDisplay(last.timestamp):'N/A'} ${warn}<br>
        <b>סה"כ צפיות:</b> ${totalV.toLocaleString()}<br>
        <b>סה"כ עריכות:</b> ${a.edits.reduce((x,y)=>x+y,0).toLocaleString()}<br>
        <b>יום שיא הצפיות:</b> ${maxVDate} (${maxV.toLocaleString()} צפיות)<br>
        <b>יום שיא העריכות:</b> ${maxEDate} (${maxE.toLocaleString()} עריכות)
      </div>`;
  }
  box.innerHTML=html; show(document.getElementById('pageInfo'));
}
function renderKPIsPerArticle(articles, infos, granularity){
  const wrap=document.getElementById('kpiContainer'); let html='';
  const avgLabel = granularity==='monthly' ? 'ממוצע לחודש' : 'ממוצע ליום';

  for(let i=0;i<articles.length;i++){
    const a=state.articles[articles[i].index]; const info=infos[i];
    const views=a.views.filter(v=>v!=null);
    const total=views.reduce((s,v)=>s+(v||0),0);
    const units=views.length||1; // ימים/חודשים בהתאם לגרנולריות

    // Prev-period Δ%
    const prevCount = units; // אותו אורך חלון
    const curTotal = total;
    const prevTotal = sumNonNull(views.slice(0, Math.max(0, views.length - prevCount)));
    const deltaPct = (prevTotal && curTotal) ? Math.round(((curTotal - prevTotal) / prevTotal) * 100) : 0;
    const deltaColor = deltaPct>=0 ? 'text-green-600' : 'text-red-600';
    const deltaHtml = prevTotal ? `<span class="text-xs ${deltaColor} ml-1">(${deltaPct>=0?'+':''}${deltaPct}%)</span>` : '';

    // זמן מאז עריכה
    let ago='לא זמין';
    if(info&&info.lastEdit?.timestamp){
      const diff=Date.now()-new Date(info.lastEdit.timestamp).getTime();
      const hrs=Math.floor(diff/3600000);
      ago=hrs<48?`${hrs} שעות`:`${Math.floor(hrs/24)} ימים`;
    }

    html+=`
      <div class="bg-white p-4 rounded shadow-sm border border-gray-200">
        <div class="font-semibold mb-2">${a.title}</div>
        <div class="grid grid-cols-3 gap-3">
          <div>
            <div class="text-gray-500 text-sm">סה״כ צפיות</div>
            <div class="text-2xl font-bold">${curTotal.toLocaleString()}</div>
          </div>
          <div>
            <div class="text-gray-500 text-sm">${avgLabel} ${deltaHtml}</div>
            <div class="text-2xl font-bold">${Math.round(curTotal/units).toLocaleString()}</div>
          </div>
          <div>
            <div class="text-gray-500 text-sm">מאז עריכה אחרונה</div>
            <div class="text-2xl font-bold">${ago}</div>
          </div>
        </div>
      </div>`;
  }
  wrap.innerHTML=html; show(wrap);
}
function renderRecentEdits(articles, recentsList){
  const box=document.getElementById('recentEdits') || document.createElement('div');
  box.id='recentEdits';
  let html='';
  for(let i=0;i<articles.length;i++){
    const title=articles[i].title, recents=recentsList[i]||[];
    if(recents.length>1){
      html+=`<h3 class="text-lg font-semibold mt-3">עריכות אחרונות - ${title}:</h3><ul class="list-disc pr-6 mt-2">`;
      recents.slice(1).forEach(r=>{const d=formatDisplay(r.timestamp);const t=new Date(r.timestamp).toLocaleTimeString('he-IL');const u=r.user;const c=r.comment||'(ללא תקציר)';const link=`https://he.wikipedia.org/w/index.php?diff=cur&oldid=${r.revid}`;html+=`<li><b>${d} ${t}</b> — <b>${u}</b>: ${c} [<a href="${link}" target="_blank" class="text-blue-600 underline">השוואה לגרסה הנוכחית</a>]</li>`});
      html+='</ul>';
    }
  }
  if (!box.parentNode) document.querySelector('main').appendChild(box);
  box.innerHTML=html;
}
function renderAnomalies(primaryArticle){
  const box = document.getElementById('anomaliesBox');
  const spikes = findSpikes(primaryArticle.dates, primaryArticle.views, 4); // 4 MAD
  if (!spikes.length){ hide(box); box.innerHTML=''; return; }
  box.innerHTML = `
    <div class="font-semibold mb-2">ימים חריגים בצפיות (${spikes.length}):</div>
    <ul class="list-disc pr-6">
      ${spikes.slice(0,12).map(s=>`<li><b>${s.date}</b> — ${s.value.toLocaleString()} צפיות <span class="text-xs text-amber-700">(MAD=${s.score})</span></li>`).join('')}
    </ul>`;
  show(box);
}
function renderCorrelation(articles){
  const box = document.getElementById('corrBox');
  let html = `<div class="font-semibold mb-2">קורלציה בין צפיות לעריכות:</div><ul class="list-disc pr-6">`;
  for (const a of articles){
    const st = state.articles[a.index];
    const r = pearson(st.views, st.edits);
    const color = r==null ? 'text-gray-500' : (r>=0 ? 'text-green-700' : 'text-red-700');
    const val = r==null ? 'לא מספיק נתונים' : r.toFixed(2);
    html += `<li><b>${st.title}:</b> <span class="${color}">${val}</span></li>`;
  }
  html += `</ul>`;
  box.innerHTML = html;
  show(box);
}
function renderCharts(articles, displayDates, granularity){
  const labels = displayDates.slice();
  const smoothingOn = !!state.features.smoothing;
  const comparePrevOn = !!state.features.comparePrev;

  // Views
  if(viewsChart) viewsChart.destroy(); show(document.getElementById('viewsSummary'));
  const baseDatasets = articles.map((a,i)=>({
    label:`צפיות - ${a.title}`,
    data:state.articles[a.index].views,
    borderColor:i===0?'blue':'green',
    fill:false, spanGaps:true
  }));

  // Smoothing layer (SMA)
  const win = (granularity === 'monthly') ? 3 : 7;
  const smoothingDatasets = smoothingOn ? articles.map((a,i)=>({
    label:`מגמה (${win}) - ${a.title}`,
    data:sma(state.articles[a.index].views, win),
    borderColor:i===0?'#1f78b4':'#33a02c',
    borderDash:[6,4],
    fill:false, spanGaps:true, pointRadius:0
  })) : [];

  // Prev period shifted dataset
  const prevDatasets = comparePrevOn ? articles.map((a,i)=>{
    const series = state.articles[a.index].views;
    const shift = series.filter(v=>v!=null).length || 0; // הזחה בגודל החלון הנוכחי
    return {
      label:`טווח קודם - ${a.title}`,
      data:shiftSeries(series, shift),
      borderColor:i===0?'#1f78b4':'#33a02c',
      borderDash:[2,2],
      fill:false, spanGaps:true, pointRadius:0
    };
  }) : [];

  viewsChart=new Chart(document.getElementById('viewsChart'),{
    type:'line',
    data:{labels,datasets:[...baseDatasets,...smoothingDatasets,...prevDatasets]},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{y:{beginAtZero:true}, x:{ticks:{autoSkip:true,maxTicksLimit:24,callback:(v,idx)=>granularity==='monthly'?labels[idx].replace('/','/20'):labels[idx]}}},
      plugins:{datalabels:{display:false},legend:{display:true}}
    },
    plugins:[ChartDataLabels]
  });

  // Edits
  if(editsChart) editsChart.destroy(); show(document.getElementById('editsSummary'));
  editsChart=new Chart(document.getElementById('editsChart'),{
    type:'bar',
    data:{labels,datasets:articles.map((a,i)=>({label:`עריכות - ${a.title}`,data:state.articles[a.index].edits,backgroundColor:i===0?'orange':'purple'}))},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{y:{beginAtZero:true}, x:{ticks:{autoSkip:true,maxTicksLimit:24,callback:(v,idx)=>granularity==='monthly'?labels[idx].replace('/','/20'):labels[idx]}}},
      plugins:{legend:{display:articles.length>1}}
    }
  });
}

/* ====================== CONTROLLER ====================== */
async function loadData(){
  const loading=document.getElementById('loadingIndicator'); const err=document.getElementById('errorMessage');
  try{
    show(loading); hide(err); err.textContent='';
    const t1=document.getElementById('pageTitle1').value.trim();
    const t2=document.getElementById('pageTitle2').value.trim();
    if(!t1&&!t2){err.textContent='נא להזין לפחות שם ערך אחד';show(err);hide(loading);return}

    // update feature toggles
    state.features.smoothing = document.getElementById('toggleSmoothing').checked;
    state.features.comparePrev = document.getElementById('toggleComparePrev').checked;
    saveTogglesToStorage();
    saveStateToURL();

    const range=document.getElementById('rangeSelect').value;
    const granularity=document.getElementById('granularitySelect').value;
    const endDate=new Date(); endDate.setDate(endDate.getDate()-1);
    const apiStart=new Date('2015-07-01');

    const articles=[{title:t1,index:0},{title:t2,index:1}].filter(a=>a.title);
    const infos=await Promise.all(articles.map(a=>fetchPageInfo(a.title)));

    // init state
    for(let i=0;i<articles.length;i++){
      const a=articles[i]; const info=infos[i];
      state.articles[a.index]={title:a.title,dates:[],views:[],edits:[],createdDate:info.created?new Date(info.created.timestamp):apiStart};
    }

    // start date: "all" → המוקדם ביותר בין הערכים (לא לפני apiStart); אחרת לפי הטווח הנבחר
    let startDate;
    if(range==='all'){
      const minCreated=new Date(Math.min(...articles.map((a,i)=>state.articles[a.index].createdDate.getTime())));
      startDate = new Date(Math.max(apiStart.getTime(), minCreated.getTime()));
    }else{
      startDate=new Date(endDate); startDate.setDate(endDate.getDate()-parseInt(range,10));
    }

    const toAPI=d=>d.toISOString().slice(0,10).replace(/-/g,''); const startStr=toAPI(startDate), endStr=toAPI(endDate);

    renderWikiLinks(articles);

    // build dates union
    let dateSet=new Set();
    if(granularity==='monthly'){
      generateMonthlyDates(startDate,endDate).forEach(d=>dateSet.add(d));
    }else{
      const allViews=await Promise.all(articles.map(a=>fetchViewsData(a.title,startStr,endStr)));
      allViews.forEach(vd=>vd.dates.forEach(d=>dateSet.add(d)));
    }
    const displayDates=Array.from(dateSet).sort((a,b)=>parseDisplayDate(a,granularity)-parseDisplayDate(b,granularity));

    // fetch per-article
    const perArticle=await Promise.all(articles.map(async (a)=>{
      const [viewsData, recents]=await Promise.all([fetchViewsData(a.title,startStr,endStr), fetchRecentEdits(a.title)]);
      // Views mapped (respect creation date)
      let mappedViews=[];
      if(granularity==='monthly'){
        const map=new Map();
        viewsData.dates.forEach((date,i)=>{const d=parseDisplayDate(date,'daily');const key=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(2)}`; map.set(key,(map.get(key)||0)+(viewsData.views[i]||0))});
        mappedViews=displayDates.map(key=>{
          const d=parseDisplayDate(key,'monthly');
          return d>=state.articles[a.index].createdDate ? (map.get(key) ?? 0) : null;
        });
      }else{
        const vmap=new Map(viewsData.dates.map((d,i)=>[d,viewsData.views[i]]));
        mappedViews=displayDates.map(d=> parseDisplayDate(d,'daily')>=state.articles[a.index].createdDate ? (vmap.get(d) ?? 0) : null);
      }
      state.articles[a.index].views=mappedViews;
      state.articles[a.index].dates=displayDates;

      // Edits mapped (0 לפני יצירה)
      const edits=await fetchEditsData(a.title,startDate,endDate,granularity,displayDates);
      state.articles[a.index].edits = displayDates.map((d,idx)=> {
        const dt=parseDisplayDate(d,granularity);
        return dt>=state.articles[a.index].createdDate ? edits[idx] : 0;
      });

      return { recents };
    }));
    const recentsList=perArticle.map(x=>x.recents);

    if(!articles.length || !displayDates.length){err.textContent='לא נמצאו נתונים להצגה';show(err);hide(loading);return}

    // render
    renderSummaries(articles,displayDates,infos);
    renderKPIsPerArticle(articles,infos,granularity);
    renderCharts(articles,displayDates,granularity);
    renderRecentEdits(articles,recentsList);

    // Insights (1) anomalies on first article series
    const primary = state.articles[ (articles[0]||{}).index ];
    if (primary) renderAnomalies(primary);

    // Insights (2) correlation per article
    renderCorrelation(articles);

    hide(loading); toast();
  }catch(e){
    console.error('loadData',e);
    const errDiv=document.getElementById('errorMessage');
    errDiv.textContent=`אירעה שגיאה בטעינת הנתונים: ${e.message||e}. נא לנסות שוב.`; show(errDiv);
    hide(document.getElementById('loadingIndicator'));
  }
}

/* ====================== CSV ====================== */
function downloadCSV(){
  try{
    const articles=state.articles.filter(a=>a.title);
    if(!articles.length){const e=document.getElementById('errorMessage');e.textContent='אין נתונים להורדה';show(e);return;}
    let csv='\uFEFFתאריך'; articles.forEach(a=>{csv+=`,צפיות - ${a.title},עריכות - ${a.title}`}); csv+='\n';
    const maxLen=Math.max(...articles.map(a=>a.dates.length));
    for(let i=0;i<maxLen;i++){const date=articles[0].dates[i]||''; let row=`${date}`; articles.forEach(a=>{row+=`,`+(a.views[i]!==null?(a.views[i]||0):'')+`,`+(a.edits[i]||0)}); csv+=row+'\n'}
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download=`wiki_stats_${articles.map(a=>a.title).join('_vs_')}.csv`; link.click();
  }catch(e){console.error('downloadCSV',e); const err=document.getElementById('errorMessage'); err.textContent='אירעה שגיאה בהורדת הקובץ'; show(err);}
}

/* ====================== INIT ====================== */
document.addEventListener('DOMContentLoaded',()=>{
  loadTogglesFromStorage();
  loadStateFromURL();

  const runOnEnter=ev=>{if(ev.key==='Enter') loadData()};
  document.getElementById('pageTitle1').addEventListener('keydown',runOnEnter);
  document.getElementById('pageTitle2').addEventListener('keydown',runOnEnter);

  document.getElementById('toggleSmoothing').addEventListener('change', ()=>{ saveTogglesToStorage(); });
  document.getElementById('toggleComparePrev').addEventListener('change', ()=>{ saveTogglesToStorage(); });

  document.getElementById('loadDataButton').addEventListener('click',loadData);
  document.getElementById('downloadCSVButton').addEventListener('click',downloadCSV);
});
</script>
</body>
</html>
