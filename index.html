<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>מעקב עריכות ויקיפדיה לפי קטגוריות</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  select { margin: 10px; }
</style>
</head>
<body>

<h1>מעקב עריכות בויקיפדיה לפי קטגוריות</h1>
<div>
  <label>בחר קטגוריה:
    <select id="categoryFilter">
      <option value="">הכל</option>
    </select>
  </label>
  <label>בחר תאריך:
    <select id="dateFilter">
      <option value="">הכל</option>
    </select>
  </label>
</div>

<table id="editsTable">
<thead>
<tr>
  <th>תאריך</th>
  <th>שעה</th>
  <th>שם הערך</th>
  <th>קטגוריה</th>
  <th>גודל שינוי</th>
  <th>מספר עריכות</th>
  <th>קישור לערך</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const targets = [
  'קטגוריה:עיתונאים_ישראלים', 'קטגוריה:עיתונאיות_ישראליות', 'קטגוריה:חברי_הכנסת_העשרים_וחמש',
  'קטגוריה:שופטי_בית_המשפט_העליון', 'קטגוריה:שופטי_בית_המשפט_העליון_בדימוס',
  'קטגוריה:המחאה_נגד_בנימין_נתניהו:_אישים', 'קטגוריה:מפקדי_אוגדות_במלחמת_חרבות_ברזל',
  'קטגוריה:חברי_המטה_הכללי_של_צה"ל', 'קטגוריה:תתי-אלופים_בצה"ל', 'קטגוריה:מעשי_טבח_בישראל'
];

let allEdits = [];
const proxy = 'https://api.allorigins.win/get?url=';

async function loadEdits() {
  const today = new Date();
  const recentDates = [...Array(3)].map((_, i) => {
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    return d.toISOString().split('T')[0];
  });

  for (const target of targets) {
    const url = `https://he.wikipedia.org/wiki/מיוחד:שינויים_בדפים_המקושרים?target=${encodeURIComponent(target)}&limit=500&days=3&hidebots=1&hideWikibase=1`;
    const response = await fetch(proxy + encodeURIComponent(url));
    const data = await response.json();
    const html = data.contents;
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    let currentDate = '';
    const listItems = doc.querySelectorAll('ul.special > li, h4');
    listItems.forEach(item => {
      if (item.tagName === 'H4') {
        currentDate = item.textContent.trim();
      } else if (item.className.includes('mw-changeslist-line')) {
        const titleEl = item.querySelector('.mw-title');
        const timeEl = item.querySelector('.mw-changeslist-time');
        const diffEl = item.querySelector('.mw-diff-bytes');

        if (titleEl && timeEl) {
          const pageName = titleEl.textContent.trim();
          const time = timeEl.textContent.trim();
          const fullDate = convertHebrewDate(currentDate);
          const formattedDate = fullDate.toISOString().split('T')[0];
          const formattedTime = time;

          if (recentDates.includes(formattedDate)) {
            allEdits.push({
              date: formattedDate,
              time: formattedTime,
              title: pageName,
              category: target,
              sizeChange: diffEl ? diffEl.textContent.trim() : '',
              url: `https://he.wikipedia.org/wiki/${encodeURIComponent(pageName)}`
            });
          }
        }
      }
    });
  }
  processEdits();
}

function convertHebrewDate(text) {
  const months = { 'ינואר':1, 'פברואר':2, 'מרץ':3, 'אפריל':4, 'מאי':5, 'יוני':6,
                   'יולי':7, 'אוגוסט':8, 'ספטמבר':9, 'אוקטובר':10, 'נובמבר':11, 'דצמבר':12 };
  const parts = text.split(' ');
  return new Date(parts[2], months[parts[1]]-1, parts[0]);
}

function processEdits() {
  const uniqueEdits = {};
  allEdits.forEach(edit => {
    const key = edit.date + edit.title;
    if (!uniqueEdits[key]) {
      uniqueEdits[key] = { ...edit, editCount: 1 };
    } else {
      uniqueEdits[key].editCount++;
    }
  });

  const finalEdits = Object.values(uniqueEdits);
  populateFilters(finalEdits);
  populateTable(finalEdits);
}

function populateFilters(edits) {
  const categorySet = new Set(edits.map(e => e.category));
  const dateSet = new Set(edits.map(e => e.date));

  const catSelect = document.getElementById('categoryFilter');
  categorySet.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    catSelect.appendChild(opt);
  });

  const dateSelect = document.getElementById('dateFilter');
  [...dateSet].sort().forEach(date => {
    const opt = document.createElement('option');
    opt.value = date;
    opt.textContent = date;
    dateSelect.appendChild(opt);
  });

  catSelect.addEventListener('change', applyFilters);
  dateSelect.addEventListener('change', applyFilters);
}

function applyFilters() {
  const selectedCat = document.getElementById('categoryFilter').value;
  const selectedDate = document.getElementById('dateFilter').value;

  let filtered = Object.values(allEdits);

  if (selectedCat) filtered = filtered.filter(e => e.category === selectedCat);
  if (selectedDate) filtered = filtered.filter(e => e.date === selectedDate);

  processEdits();
}

function populateTable(edits) {
  const tbody = document.querySelector('#editsTable tbody');
  tbody.innerHTML = '';
  edits.forEach(edit => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${edit.date}</td>
      <td>${edit.time}</td>
      <td>${edit.title}</td>
      <td>${edit.category}</td>
      <td>${edit.sizeChange}</td>
      <td>${edit.editCount}</td>
      <td><a href="${edit.url}" target="_blank">צפה</a></td>
    `;
    tbody.appendChild(tr);
  });
}

document.addEventListener('DOMContentLoaded', loadEdits);
</script>

</body>
</html>
